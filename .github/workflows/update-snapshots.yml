name: Update Visual Snapshots

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Browser project to update (chromium, firefox, webkit, mobile-chrome, mobile-safari, or all)'
        required: true
        default: 'firefox'
        type: choice
        options:
          - firefox
          - chromium
          - webkit
          - mobile-chrome
          - mobile-safari
          - all

permissions:
  contents: write
  pull-requests: write

jobs:
  update-snapshots:
    name: Update ${{ inputs.project }} Snapshots
    # Only run on the original repo - prevents forks from using our Actions minutes
    if: github.repository == 'FeeDeur-UIQA/Github-QA-Portfolio'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: |
          if [ "${{ inputs.project }}" = "all" ]; then
            npx playwright install --with-deps
          else
            npx playwright install --with-deps ${{ inputs.project }}
          fi

      - name: Update snapshots for specific project
        if: inputs.project != 'all'
        run: |
          npx playwright test --project=${{ inputs.project }} --update-snapshots \
            --grep @visual --grep @critical
        continue-on-error: true

      - name: Update snapshots for all projects
        if: inputs.project == 'all'
        run: |
          npx playwright test --update-snapshots --grep @visual --grep @critical
        continue-on-error: true

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet tests/**/*-snapshots/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No snapshot changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Snapshot changes detected"
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update ${{ inputs.project }} visual baseline snapshots [skip ci]'
          title: 'chore: Update ${{ inputs.project }} Visual Baselines'
          body: |
            ## Visual Baseline Update

            This PR updates visual regression baseline snapshots for **${{ inputs.project }}**.

            ### Changes
            - Platform: `ubuntu-latest` (Linux)
            - Browser: ${{ inputs.project }}
            - Updated: Visual regression critical tests

            ### Review Checklist
            - [ ] Verify snapshot changes are intentional
            - [ ] Check for unintended visual regressions
            - [ ] Ensure baselines match expected UI state

            **Auto-generated by workflow run:** ${{ github.run_id }}
          branch: snapshots/${{ inputs.project }}-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            visual-regression
            snapshots

      - name: Summary
        run: |
          echo "### Snapshot Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ inputs.project }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: ubuntu-latest (Linux)" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes**: ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Files Changed:**" >> $GITHUB_STEP_SUMMARY
            git diff --name-only tests/**/*-snapshots/ >> $GITHUB_STEP_SUMMARY || echo "No changes" >> $GITHUB_STEP_SUMMARY
          fi
