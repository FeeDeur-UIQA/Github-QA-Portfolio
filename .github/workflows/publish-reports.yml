name: Publish Test Reports

on:
  workflow_run:
    workflows:
      - 'Playwright Test Suite'
      - 'Smoke Tests'
      - 'Flow Tests (E2E)'
      - 'Visual Stability Monitor'
      - 'Security Audit'
      - 'Performance Budgets'
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: false

jobs:
  publish-reports:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion != 'cancelled'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Create report directories
        run: |
          mkdir -p public/{playwright,smoke,e2e,visual,security,performance}
          echo "üìÇ Report structure initialized"

      - name: Download triggering workflow artifacts
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: artifacts/current
        continue-on-error: true

      - name: Fetch Playwright artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: playwright.yml
          name: playwright-report-merged
          path: artifacts/playwright
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Smoke artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: smoke-tests.yml
          name: smoke-dashboard
          path: artifacts/smoke
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Flow Test artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: flow-tests.yml
          name_is_regexp: true
          name: flow-report-.*
          path: artifacts/flow
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Visual Stability artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: visual-stability-monitor.yml
          name: visual-flake-detection
          path: artifacts/visual
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Security Audit artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: security-audit.yml
          name: npm-audit-results
          path: artifacts/security
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Lighthouse artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: lighthouse.yml
          name: lighthouse-results
          path: artifacts/lighthouse
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Aggregate reports
        run: |
          echo "üìä Aggregating test reports..."
          
          # Playwright suite
          if [ -d "artifacts/playwright" ]; then
            cp -r artifacts/playwright/* public/playwright/ 2>/dev/null || true
            echo "‚úÖ Playwright report copied"
          fi
          
          # Smoke tests
          if [ -d "artifacts/smoke" ]; then
            cp -r artifacts/smoke/* public/smoke/ 2>/dev/null || true
            echo "‚úÖ Smoke dashboard copied"
          fi
          
          # Flow/E2E tests
          if [ -d "artifacts/flow" ]; then
            for dir in artifacts/flow/*/; do
              if [ -d "$dir/playwright-report" ]; then
                cp -r "$dir/playwright-report"/* public/e2e/ 2>/dev/null || true
              elif [ -d "$dir" ]; then
                cp -r "$dir"/* public/e2e/ 2>/dev/null || true
              fi
            done
            echo "‚úÖ E2E reports merged"
          fi
          
          # Visual stability
          if [ -d "artifacts/visual" ]; then
            cp -r artifacts/visual/* public/visual/ 2>/dev/null || true
            echo "‚úÖ Visual stability report copied"
          fi
          
          # Security audit
          if [ -d "artifacts/security" ]; then
            cp -r artifacts/security/* public/security/ 2>/dev/null || true
            echo "‚úÖ Security audit copied"
          fi
          
          # Lighthouse
          if [ -d "artifacts/lighthouse" ]; then
            cp -r artifacts/lighthouse/* public/performance/ 2>/dev/null || true
            echo "‚úÖ Performance report copied"
          fi
          
          echo ""
          echo "üìÇ Final structure:"
          find public -type f | head -30

      - name: Generate dashboard
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>QA Portfolio - Test Dashboard</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
              .header { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); padding: 3rem 2rem; text-align: center; border-bottom: 1px solid #334155; }
              .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
              .header p { color: #94a3b8; }
              .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
              .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
              .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; transition: transform 0.2s, box-shadow 0.2s; }
              .card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.3); }
              .card-icon { font-size: 2rem; margin-bottom: 1rem; }
              .card h2 { font-size: 1.25rem; margin-bottom: 0.5rem; color: #f1f5f9; }
              .card p { color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem; line-height: 1.5; }
              .card a { display: inline-block; background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 500; font-size: 0.875rem; }
              .card a:hover { background: #2563eb; }
              .footer { text-align: center; padding: 2rem; color: #64748b; font-size: 0.875rem; border-top: 1px solid #334155; margin-top: 2rem; }
              .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem; }
              .badge-smoke { background: #f59e0b; color: #000; }
              .badge-e2e { background: #10b981; color: #000; }
              .badge-visual { background: #8b5cf6; color: #fff; }
              .badge-security { background: #ef4444; color: #fff; }
              .badge-perf { background: #06b6d4; color: #000; }
              .badge-full { background: #3b82f6; color: #fff; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üéØ QA Test Dashboard</h1>
              <p>Automated test results from CI pipeline</p>
            </div>
            <div class="container">
              <div class="grid">
                <div class="card">
                  <div class="card-icon">üß™</div>
                  <h2>Playwright Suite <span class="badge badge-full">Full</span></h2>
                  <p>Complete test suite across 5 browsers with sharding. Smoke, E2E, API, and visual tests.</p>
                  <a href="playwright/index.html">View Report ‚Üí</a>
                </div>
                <div class="card">
                  <div class="card-icon">‚ö°</div>
                  <h2>Smoke Tests <span class="badge badge-smoke">Fast</span></h2>
                  <p>Critical path validation under 20s. Health checks, auth, cart, and search flows.</p>
                  <a href="smoke/index.html">View Dashboard ‚Üí</a>
                </div>
                <div class="card">
                  <div class="card-icon">üîç</div>
                  <h2>E2E Flow Tests <span class="badge badge-e2e">Deep</span></h2>
                  <p>Feature-level validation: auth, cart, catalog, and account workflows.</p>
                  <a href="e2e/index.html">View Report ‚Üí</a>
                </div>
                <div class="card">
                  <div class="card-icon">üì∏</div>
                  <h2>Visual Stability <span class="badge badge-visual">Monitor</span></h2>
                  <p>Weekly flake detection and screenshot comparison tracking.</p>
                  <a href="visual/index.html">View Analysis ‚Üí</a>
                </div>
                <div class="card">
                  <div class="card-icon">üîí</div>
                  <h2>Security Audit <span class="badge badge-security">Scan</span></h2>
                  <p>NPM vulnerability scan. Zero-tolerance for high/critical CVEs.</p>
                  <a href="security/index.html">View Audit ‚Üí</a>
                </div>
                <div class="card">
                  <div class="card-icon">‚ö°</div>
                  <h2>Performance <span class="badge badge-perf">Lighthouse</span></h2>
                  <p>Core Web Vitals: LCP, FID, CLS budget enforcement.</p>
                  <a href="performance/index.html">View Metrics ‚Üí</a>
                </div>
              </div>
            </div>
            <div class="footer">
              <p>Auto-generated by GitHub Actions</p>
            </div>
          </body>
          </html>
          EOF

      - name: Generate placeholder pages
        run: |
          for section in playwright smoke e2e visual security performance; do
            if [ ! -f "public/$section/index.html" ]; then
              echo "‚ö†Ô∏è Creating placeholder for $section"
              cat > "public/$section/index.html" << PLACEHOLDER
          <!DOCTYPE html>
          <html>
          <head>
            <title>${section^} Report</title>
            <style>
              body { font-family: system-ui; background: #0f172a; color: #e2e8f0; display: flex; align-items: center; justify-content: center; min-height: 100vh; text-align: center; }
              .container { max-width: 500px; padding: 2rem; }
              h1 { margin-bottom: 1rem; }
              p { color: #94a3b8; margin-bottom: 1.5rem; }
              a { color: #3b82f6; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üìä ${section^} Report</h1>
              <p>No data available. Workflow hasn't run yet.</p>
              <p><a href="../">‚Üê Back to Dashboard</a></p>
            </div>
          </body>
          </html>
          PLACEHOLDER
            fi
          done

      - name: Generate visual report page
        run: |
          if [ -f "public/visual/visual-flakes.json" ]; then
            cat > public/visual/index.html << 'VISUALPAGE'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Visual Stability Report</title>
            <style>
              body { font-family: system-ui; background: #0f172a; color: #e2e8f0; padding: 2rem; }
              .container { max-width: 900px; margin: 0 auto; }
              h1 { margin-bottom: 1rem; }
              .summary { background: #1e293b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; }
              .stat { display: inline-block; margin-right: 2rem; }
              .stat-value { font-size: 2rem; font-weight: bold; }
              .stat-label { color: #94a3b8; font-size: 0.875rem; }
              pre { background: #1e293b; padding: 1rem; border-radius: 8px; overflow-x: auto; }
              a { color: #3b82f6; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üì∏ Visual Stability Report</h1>
              <div class="summary">
                <div class="stat"><div class="stat-value" id="stable">-</div><div class="stat-label">Stable</div></div>
                <div class="stat"><div class="stat-value" id="noisy">-</div><div class="stat-label">Noisy</div></div>
                <div class="stat"><div class="stat-value" id="unstable">-</div><div class="stat-label">Unstable</div></div>
              </div>
              <h2>Raw Data</h2>
              <pre id="json"></pre>
              <p style="margin-top:2rem;"><a href="../">‚Üê Back to Dashboard</a></p>
            </div>
            <script>
              fetch('visual-flakes.json').then(r=>r.json()).then(d=>{
                document.getElementById('stable').textContent=d.summary?.stable||0;
                document.getElementById('noisy').textContent=d.summary?.noisy||0;
                document.getElementById('unstable').textContent=d.summary?.unstable||0;
                document.getElementById('json').textContent=JSON.stringify(d,null,2);
              }).catch(()=>{document.getElementById('json').textContent='Failed to load';});
            </script>
          </body>
          </html>
          VISUALPAGE
          fi

      - name: Generate security report page
        run: |
          if [ -f "public/security/audit-results.json" ]; then
            cat > public/security/index.html << 'SECPAGE'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Security Audit</title>
            <style>
              body { font-family: system-ui; background: #0f172a; color: #e2e8f0; padding: 2rem; }
              .container { max-width: 900px; margin: 0 auto; }
              h1 { margin-bottom: 1rem; }
              .summary { background: #1e293b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; display: flex; gap: 2rem; }
              .stat { text-align: center; }
              .stat-value { font-size: 2rem; font-weight: bold; }
              .stat-label { color: #94a3b8; font-size: 0.875rem; }
              .critical { color: #ef4444; }
              .high { color: #f97316; }
              .moderate { color: #eab308; }
              .low { color: #22c55e; }
              pre { background: #1e293b; padding: 1rem; border-radius: 8px; overflow-x: auto; max-height: 400px; }
              a { color: #3b82f6; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üîí Security Audit</h1>
              <div class="summary">
                <div class="stat"><div class="stat-value critical" id="critical">-</div><div class="stat-label">Critical</div></div>
                <div class="stat"><div class="stat-value high" id="high">-</div><div class="stat-label">High</div></div>
                <div class="stat"><div class="stat-value moderate" id="moderate">-</div><div class="stat-label">Moderate</div></div>
                <div class="stat"><div class="stat-value low" id="low">-</div><div class="stat-label">Low</div></div>
              </div>
              <h2>Details</h2>
              <pre id="json"></pre>
              <p style="margin-top:2rem;"><a href="../">‚Üê Back to Dashboard</a></p>
            </div>
            <script>
              fetch('audit-results.json').then(r=>r.json()).then(d=>{
                const v=d.metadata?.vulnerabilities||{};
                document.getElementById('critical').textContent=v.critical||0;
                document.getElementById('high').textContent=v.high||0;
                document.getElementById('moderate').textContent=v.moderate||0;
                document.getElementById('low').textContent=v.low||0;
                document.getElementById('json').textContent=JSON.stringify(d,null,2);
              }).catch(()=>{document.getElementById('json').textContent='Failed to load';});
            </script>
          </body>
          </html>
          SECPAGE
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post summary
        run: |
          echo "## üéØ Test Dashboard Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Dashboard:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: \`${{ github.event.workflow_run.name || 'manual' }}\`" >> $GITHUB_STEP_SUMMARY
