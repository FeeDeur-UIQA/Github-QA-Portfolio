name: Publish Test Reports

# Callable by CI Orchestrator only (single publish per pipeline)
on:
  workflow_call:  # Called by ci-orchestrator.yml (Stage 3)
  workflow_dispatch:  # Manual runs still supported

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-deploy
  cancel-in-progress: false

jobs:
  publish-reports:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Create report directories
        run: |
          mkdir -p public/{playwright,smoke,e2e,visual,security,performance}
          echo "üìÇ Report structure initialized"

      - name: Download triggering workflow artifacts
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: artifacts/current
        continue-on-error: true

      - name: Fetch Playwright artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: playwright.yml
          name: playwright-report-merged
          path: artifacts/playwright
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Smoke artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: smoke-tests.yml
          name: smoke-dashboard
          path: artifacts/smoke
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Flow Test artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: flow-tests.yml
          name_is_regexp: true
          name: flow-report-.*
          path: artifacts/flow
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Visual Stability artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: visual-stability-monitor.yml
          name: visual-flake-detection
          path: artifacts/visual
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Security Audit artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: security-audit.yml
          name: npm-audit-results
          path: artifacts/security
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Fetch Lighthouse artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: lighthouse.yml
          name: lighthouse-results
          path: artifacts/lighthouse
          if_no_artifact_found: ignore
        continue-on-error: true

      - name: Aggregate reports
        run: |
          echo "üìä Aggregating test reports..."
          
          # Playwright suite
          if [ -d "artifacts/playwright" ]; then
            cp -r artifacts/playwright/* public/playwright/ 2>/dev/null || true
            echo "‚úÖ Playwright report copied"
          fi
          
          # Smoke tests
          if [ -d "artifacts/smoke" ]; then
            cp -r artifacts/smoke/* public/smoke/ 2>/dev/null || true
            echo "‚úÖ Smoke dashboard copied"
          fi
          
          # Flow/E2E tests
          if [ -d "artifacts/flow" ]; then
            for dir in artifacts/flow/*/; do
              if [ -d "$dir/playwright-report" ]; then
                cp -r "$dir/playwright-report"/* public/e2e/ 2>/dev/null || true
              elif [ -d "$dir" ]; then
                cp -r "$dir"/* public/e2e/ 2>/dev/null || true
              fi
            done
            echo "‚úÖ E2E reports merged"
          fi
          
          # Visual stability
          if [ -d "artifacts/visual" ]; then
            cp -r artifacts/visual/* public/visual/ 2>/dev/null || true
            echo "‚úÖ Visual stability report copied"
          fi
          
          # Security audit
          if [ -d "artifacts/security" ]; then
            cp -r artifacts/security/* public/security/ 2>/dev/null || true
            echo "‚úÖ Security audit copied"
          fi
          
          # Lighthouse
          if [ -d "artifacts/lighthouse" ]; then
            cp -r artifacts/lighthouse/* public/performance/ 2>/dev/null || true
            echo "‚úÖ Performance report copied"
          fi
          
          echo ""
          echo "üìÇ Final structure:"
          find public -type f | head -30

      - name: Generate dashboard
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta name="description" content="Quality Intelligence Hub - Unified Test Observability Dashboard">
            <meta name="color-scheme" content="dark light">
            <title>Quality Intelligence Hub | QA Portfolio</title>
            
            <!-- Fonts -->
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
            
            <style>
              /* === DESIGN TOKENS === */
              :root {
                --bg-primary: #020617;
                --bg-secondary: rgba(30, 41, 59, 0.6);
                --bg-tertiary: rgba(15, 23, 42, 0.8);
                --border-subtle: rgba(255, 255, 255, 0.15);
                --border-medium: rgba(255, 255, 255, 0.12);
                --text-primary: #f1f5f9;
                --text-secondary: #94a3b8;
                --text-muted: #94a3b8;
                --accent-blue: #38bdf8;
                --accent-green: #4ade80;
                --accent-amber: #fbbf24;
                --accent-red: #f87171;
                --accent-purple: #a78bfa;
                --accent-cyan: #22d3ee;
                --accent-slate: #94a3b8;
                --shadow-glow: 0 0 40px rgba(56, 189, 248, 0.15);
                --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.4);
                --radius-sm: 6px;
                --radius-md: 12px;
                --radius-lg: 16px;
                --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
              }

              @media (prefers-color-scheme: light) {
                :root {
                  --bg-primary: #f8fafc;
                  --bg-secondary: rgba(241, 245, 249, 0.9);
                  --bg-tertiary: rgba(226, 232, 240, 0.8);
                  --border-subtle: rgba(0, 0, 0, 0.06);
                  --border-medium: rgba(0, 0, 0, 0.1);
                  --text-primary: #0f172a;
                  --text-secondary: #475569;
                  --text-muted: #64748b;
                  --shadow-glow: 0 0 40px rgba(56, 189, 248, 0.1);
                  --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.08);
                }
              }

              /* === RESET & BASE === */
              *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
              
              html { scroll-behavior: smooth; }
              
              body {
                font-family: var(--font-sans);
                background: var(--bg-primary);
                background-image: radial-gradient(ellipse at 50% -20%, rgba(56, 189, 248, 0.08) 0%, transparent 60%);
                color: var(--text-primary);
                line-height: 1.6;
                min-height: 100vh;
                -webkit-font-smoothing: antialiased;
              }

              /* === ACCESSIBILITY === */
              .skip-link {
                position: absolute;
                top: -100%;
                left: 50%;
                transform: translateX(-50%);
                background: var(--accent-blue);
                color: var(--bg-primary);
                padding: 0.75rem 1.5rem;
                border-radius: var(--radius-md);
                font-weight: 600;
                z-index: 1000;
                transition: top 0.2s;
              }
              .skip-link:focus { top: 1rem; }

              :focus-visible {
                outline: 2px solid var(--accent-blue);
                outline-offset: 2px;
              }

              @media (prefers-reduced-motion: reduce) {
                *, *::before, *::after {
                  animation-duration: 0.01ms !important;
                  transition-duration: 0.01ms !important;
                }
              }

              /* === LAYOUT === */
              .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem 1.5rem;
              }

              @media (min-width: 768px) {
                .container { padding: 3rem 2rem; }
              }

              /* === HEADER === */
              header {
                margin-bottom: 3rem;
                text-align: center;
              }

              .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                font-family: var(--font-mono);
                font-size: 0.7rem;
                font-weight: 500;
                letter-spacing: 0.15em;
                color: var(--accent-green);
                border: 1px solid var(--accent-green);
                padding: 0.35rem 0.85rem;
                border-radius: 100px;
                margin-bottom: 1.25rem;
                box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
              }

              .status-badge::before {
                content: '';
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: var(--accent-green);
                animation: pulse 2s ease-in-out infinite;
              }

              @keyframes pulse {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.5; transform: scale(0.9); }
              }

              h1 {
                font-size: clamp(2rem, 5vw, 3rem);
                font-weight: 300;
                letter-spacing: -0.02em;
                margin-bottom: 0.5rem;
              }

              h1 strong {
                font-weight: 600;
                background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
              }

              .subtitle {
                font-family: var(--font-mono);
                font-size: 0.9rem;
                color: var(--text-muted);
              }

              /* === CARD GRID === */
              .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
                gap: 1.5rem;
              }

              .card {
                position: relative;
                background: var(--bg-secondary);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-lg);
                padding: 1.75rem;
                overflow: hidden;
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
                flex-direction: column;
              }

              .card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 3px;
                background: var(--card-accent, var(--accent-blue));
              }

              @media (prefers-reduced-motion: no-preference) {
                .card:hover, .card:focus-within {
                  transform: translateY(-6px);
                  box-shadow: var(--shadow-card), 0 0 30px color-mix(in srgb, var(--card-accent, var(--accent-blue)) 20%, transparent);
                }
              }

              .card-icon {
                width: 44px;
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: color-mix(in srgb, var(--card-accent, var(--accent-blue)) 15%, transparent);
                border-radius: var(--radius-md);
                margin-bottom: 1rem;
              }

              .card-icon svg {
                width: 24px;
                height: 24px;
                stroke: var(--card-accent, var(--accent-blue));
                fill: none;
                stroke-width: 2;
              }

              .card h2 {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
              }

              .badge {
                font-family: var(--font-mono);
                font-size: 0.65rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
                background: color-mix(in srgb, var(--card-accent, var(--accent-blue)) 20%, transparent);
                color: var(--card-accent, var(--accent-blue));
              }

              .card p {
                color: var(--text-secondary);
                font-size: 0.9rem;
                line-height: 1.6;
                margin-bottom: 1.25rem;
                flex-grow: 1;
              }

              .card-stats {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.25rem;
                font-family: var(--font-mono);
                font-size: 0.75rem;
              }

              .stat {
                background: var(--bg-tertiary);
                padding: 0.35rem 0.7rem;
                border-radius: var(--radius-sm);
                border: 1px solid var(--border-subtle);
                color: var(--text-secondary);
              }

              .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                width: 180px;
                padding: 0.7rem 1.25rem;
                background: var(--text-primary);
                color: var(--bg-primary);
                border-radius: var(--radius-sm);
                text-decoration: none;
                font-weight: 600;
                font-size: 0.85rem;
                transition: all 0.15s;
              }

              .btn:hover {
                background: var(--card-accent, var(--accent-blue));
              }

              .btn svg {
                width: 16px;
                height: 16px;
                stroke: currentColor;
                fill: none;
                stroke-width: 2;
              }

              /* === FOOTER === */
              footer {
                margin-top: 4rem;
                padding-top: 1.5rem;
                border-top: 1px solid var(--border-subtle);
                text-align: center;
                font-family: var(--font-mono);
                font-size: 0.7rem;
                color: var(--text-muted);
                letter-spacing: 0.05em;
              }

              footer a {
                color: var(--accent-blue);
                text-decoration: none;
              }
              footer a:hover { text-decoration: underline; }

              /* === PRINT === */
              @media print {
                body { background: white; color: black; }
                .card { break-inside: avoid; box-shadow: none; border: 1px solid #e2e8f0; }
              }
            </style>
          </head>
          <body>
            <a href="#main-content" class="skip-link">Skip to main content</a>
            
            <div class="container">
              <header>
                <div class="status-badge" role="status">SYSTEMS OPERATIONAL</div>
                <h1>Quality<strong>Assurance</strong>.hub</h1>
                <p class="subtitle">Unified Test Observability // Automation Lifecycle</p>
              </header>

              <main id="main-content" role="main">
                <div class="grid">
                  <!-- Playwright Suite -->
                  <article class="card" style="--card-accent: var(--accent-blue)" tabindex="0">
                    <div class="card-icon">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/></svg>
                    </div>
                    <h2>Playwright Suite <span class="badge">Full</span></h2>
                    <div class="card-stats">
                      <span class="stat">5 BROWSERS</span>
                      <span class="stat">SHARDED</span>
                    </div>
                    <p>Complete test suite with parallel execution across Chromium, Firefox, WebKit, Mobile Chrome & Safari.</p>
                    <a href="playwright/index.html" class="btn" aria-label="Explore Playwright Full Suite">
                      Explore Full Suite
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </a>
                  </article>

                  <!-- Smoke Tests -->
                  <article class="card" style="--card-accent: var(--accent-blue)" tabindex="0">
                    <div class="card-icon">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    </div>
                    <h2>Smoke Tests <span class="badge">Fast</span></h2>
                    <div class="card-stats">
                      <span class="stat">< 20s</span>
                      <span class="stat">CRITICAL PATH</span>
                    </div>
                    <p>High-velocity validation ensuring deployment stability. Health, auth, cart, and search flows.</p>
                    <a href="smoke/index.html" class="btn" aria-label="View Smoke Tests Dashboard">
                      Launch Dashboard
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </a>
                  </article>

                  <!-- E2E Flow Tests -->
                  <article class="card" style="--card-accent: var(--accent-blue)" tabindex="0">
                    <div class="card-icon">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                    </div>
                    <h2>E2E Flow Tests <span class="badge">Deep</span></h2>
                    <div class="card-stats">
                      <span class="stat">BEHAVIORAL</span>
                      <span class="stat">EDGE CASES</span>
                    </div>
                    <p>Feature-level validation with exhaustive edge-case analysis. Auth, cart, catalog workflows.</p>
                    <a href="e2e/index.html" class="btn" aria-label="Review E2E Flow Test Scenarios">
                      Review Scenarios
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </a>
                  </article>

                  <!-- Visual Stability -->
                  <article class="card" style="--card-accent: var(--accent-slate)" tabindex="0">
                    <div class="card-icon">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    </div>
                    <h2>Visual Stability <span class="badge">Monitor</span></h2>
                    <div class="card-stats">
                      <span class="stat">WEEKLY</span>
                      <span class="stat">FLAKE DETECTION</span>
                    </div>
                    <p>Screenshot comparison and visual regression tracking. Automated flake identification.</p>
                    <a href="visual/index.html" class="btn" aria-label="Compare Visual Stability Snapshots">
                      Compare Snapshots
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </a>
                  </article>

                  <!-- Security Audit -->
                  <article class="card" style="--card-accent: var(--accent-slate)" tabindex="0">
                    <div class="card-icon">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    </div>
                    <h2>Security Audit <span class="badge">Scan</span></h2>
                    <div class="card-stats">
                      <span class="stat">NPM AUDIT</span>
                      <span class="stat">ZERO TOLERANCE</span>
                    </div>
                    <p>Dependency vulnerability scanning. Zero-tolerance policy for high/critical severity CVEs.</p>
                    <a href="security/index.html" class="btn" aria-label="Check Security Vulnerabilities">
                      Check Vulnerabilities
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </a>
                  </article>

                  <!-- Performance -->
                  <article class="card" style="--card-accent: var(--accent-slate)" tabindex="0">
                    <div class="card-icon">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    </div>
                    <h2>Performance <span class="badge">Lighthouse</span></h2>
                    <div class="card-stats">
                      <span class="stat">CORE WEB VITALS</span>
                      <span class="stat">BUDGETS</span>
                    </div>
                    <p>LCP, FID, CLS enforcement with automated budget validation. Lighthouse CI integration.</p>
                    <a href="performance/index.html" class="btn" aria-label="View Performance Vitals">
                      View Vitals
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </a>
                  </article>
                </div>
              </main>

              <footer>
                <p>PLAYWRIGHT_ENGINE // GITHUB_ACTIONS // <a href="https://github.com/FeeDeur-UIQA/Github-QA-Portfolio" target="_blank" rel="noopener">QA_PORTFOLIO</a></p>
                <p style="margin-top: 0.5rem; opacity: 0.7">Auto-generated by CI Pipeline</p>
              </footer>
            </div>
          </body>
          </html>
          EOF

      - name: Generate placeholder pages
        run: |
          for section in playwright smoke e2e visual security performance; do
            if [ ! -f "public/$section/index.html" ]; then
              echo "‚ö†Ô∏è Creating placeholder for $section"
              cat > "public/$section/index.html" << PLACEHOLDER
          <!DOCTYPE html>
          <html>
          <head>
            <title>${section^} Report</title>
            <style>
              body { font-family: system-ui; background: #0f172a; color: #e2e8f0; display: flex; align-items: center; justify-content: center; min-height: 100vh; text-align: center; }
              .container { max-width: 500px; padding: 2rem; }
              h1 { margin-bottom: 1rem; }
              p { color: #94a3b8; margin-bottom: 1.5rem; }
              a { color: #3b82f6; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üìä ${section^} Report</h1>
              <p>No data available. Workflow hasn't run yet.</p>
              <p><a href="../">‚Üê Back to Dashboard</a></p>
            </div>
          </body>
          </html>
          PLACEHOLDER
            fi
          done

      - name: Generate visual report page
        run: |
          if [ -f "public/visual/visual-flakes.json" ]; then
            cat > public/visual/index.html << 'VISUALPAGE'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Visual Stability Report</title>
            <style>
              body { font-family: system-ui; background: #0f172a; color: #e2e8f0; padding: 2rem; }
              .container { max-width: 900px; margin: 0 auto; }
              h1 { margin-bottom: 1rem; }
              .summary { background: #1e293b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; }
              .stat { display: inline-block; margin-right: 2rem; }
              .stat-value { font-size: 2rem; font-weight: bold; }
              .stat-label { color: #94a3b8; font-size: 0.875rem; }
              pre { background: #1e293b; padding: 1rem; border-radius: 8px; overflow-x: auto; }
              a { color: #3b82f6; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üì∏ Visual Stability Report</h1>
              <div class="summary">
                <div class="stat"><div class="stat-value" id="stable">-</div><div class="stat-label">Stable</div></div>
                <div class="stat"><div class="stat-value" id="noisy">-</div><div class="stat-label">Noisy</div></div>
                <div class="stat"><div class="stat-value" id="unstable">-</div><div class="stat-label">Unstable</div></div>
              </div>
              <h2>Raw Data</h2>
              <pre id="json"></pre>
              <p style="margin-top:2rem;"><a href="../">‚Üê Back to Dashboard</a></p>
            </div>
            <script>
              fetch('visual-flakes.json').then(r=>r.json()).then(d=>{
                document.getElementById('stable').textContent=d.summary?.stable||0;
                document.getElementById('noisy').textContent=d.summary?.noisy||0;
                document.getElementById('unstable').textContent=d.summary?.unstable||0;
                document.getElementById('json').textContent=JSON.stringify(d,null,2);
              }).catch(()=>{document.getElementById('json').textContent='Failed to load';});
            </script>
          </body>
          </html>
          VISUALPAGE
          fi

      - name: Generate security report page
        run: |
          if [ -f "public/security/audit-results.json" ]; then
            cat > public/security/index.html << 'SECPAGE'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Security Audit</title>
            <style>
              body { font-family: system-ui; background: #0f172a; color: #e2e8f0; padding: 2rem; }
              .container { max-width: 900px; margin: 0 auto; }
              h1 { margin-bottom: 1rem; }
              .summary { background: #1e293b; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; display: flex; gap: 2rem; }
              .stat { text-align: center; }
              .stat-value { font-size: 2rem; font-weight: bold; }
              .stat-label { color: #94a3b8; font-size: 0.875rem; }
              .critical { color: #ef4444; }
              .high { color: #f97316; }
              .moderate { color: #eab308; }
              .low { color: #22c55e; }
              pre { background: #1e293b; padding: 1rem; border-radius: 8px; overflow-x: auto; max-height: 400px; }
              a { color: #3b82f6; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üîí Security Audit</h1>
              <div class="summary">
                <div class="stat"><div class="stat-value critical" id="critical">-</div><div class="stat-label">Critical</div></div>
                <div class="stat"><div class="stat-value high" id="high">-</div><div class="stat-label">High</div></div>
                <div class="stat"><div class="stat-value moderate" id="moderate">-</div><div class="stat-label">Moderate</div></div>
                <div class="stat"><div class="stat-value low" id="low">-</div><div class="stat-label">Low</div></div>
              </div>
              <h2>Details</h2>
              <pre id="json"></pre>
              <p style="margin-top:2rem;"><a href="../">‚Üê Back to Dashboard</a></p>
            </div>
            <script>
              fetch('audit-results.json').then(r=>r.json()).then(d=>{
                const v=d.metadata?.vulnerabilities||{};
                document.getElementById('critical').textContent=v.critical||0;
                document.getElementById('high').textContent=v.high||0;
                document.getElementById('moderate').textContent=v.moderate||0;
                document.getElementById('low').textContent=v.low||0;
                document.getElementById('json').textContent=JSON.stringify(d,null,2);
              }).catch(()=>{document.getElementById('json').textContent='Failed to load';});
            </script>
          </body>
          </html>
          SECPAGE
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post summary
        run: |
          echo "## üéØ Test Dashboard Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Dashboard:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: \`${{ github.event.workflow_run.name || 'manual' }}\`" >> $GITHUB_STEP_SUMMARY
